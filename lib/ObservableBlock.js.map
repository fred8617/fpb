{"version":3,"sources":["../src/FPB/ObservableBlock.tsx"],"names":["ObservableBlock","React","memo","props","store","getComponent","item","datas","i","Component","componentProps","componentId","isFormField","component","flatComponents","recurseEverything","children","rest","finalComponentProps","defaultValue","value","renderComponentChildren","comp","chil","type","map","child","Comp","requiredRules","find","rule","components","shouldHaveOne","length","finalComponent","isPreview","autoHeight","operatedItem","h","getItemHeight","breakpoint","height","caclHeight","renderedComponent"],"mappings":"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","sourcesContent":["import React, { SFC } from 'react';\r\nimport { FPBStore, ComponentType } from './useFPBStore';\r\nimport { Observer } from 'mobx-react-lite';\r\nimport Block from './Block';\r\nimport { toJS } from 'mobx';\r\nimport FormConsumerComponent from './FormConsumerComponent';\r\nimport FPB from './FPB';\r\nimport ErrorWrapper from './ErrorWrapper';\r\nimport { findRequiredRules } from './utils';\r\nimport { Alert } from 'antd';\r\n\r\nexport interface ObservableBlockProps {\r\n  i;\r\n  store: FPBStore;\r\n  components: ComponentType[];\r\n}\r\n/**\r\n * 观察者区块\r\n * @param props @interface ObservableBlockProps\r\n */\r\nconst ObservableBlock: SFC<ObservableBlockProps> = React.memo(\r\n  (props: ObservableBlockProps) => {\r\n    // useEffect(() => {\r\n    //   console.log(\"mounted\");\r\n    // }, []);\r\n    const { store } = props;\r\n    const getComponent = () => {\r\n      const item = props.store.datas[props.i];\r\n      const {\r\n        Component,\r\n        componentProps,\r\n        componentId,\r\n        isFormField,\r\n      } = item;\r\n      const component = store.flatComponents[componentId];\r\n\r\n      // const component = store.flatComponents[componentId];\r\n      const { children, ...rest } = toJS(componentProps || {}, {\r\n        recurseEverything: true,\r\n      });\r\n      const finalComponentProps = { ...rest };\r\n      if (isFormField) {\r\n        delete finalComponentProps.defaultValue;\r\n        delete finalComponentProps.value;\r\n      }\r\n\r\n      // component.componentProps&&findRequiredRules(component.componentProps);\r\n      /**\r\n       *\r\n       * @param comp 组件类型\r\n       * @param chil 表单中的子元素部分\r\n       */\r\n      const renderComponentChildren = (comp = component, chil = children) => {\r\n        // console.log(toJS(children));\r\n        //debugger;\r\n        // //debugger\r\n\r\n        if (\r\n          comp.componentProps && //组件含有属性\r\n          comp.componentProps.children && //组件属性中包含子元素\r\n          comp.componentProps.children.type === 'array:component' //子元素为数组\r\n        ) {\r\n          // if(comp.componentProps.children.shouldHaveOne){\r\n          //   //debugger\r\n          //   chil.push({})\r\n          // }\r\n          // console.log('child');\r\n          return chil.map((child, i) => {\r\n            const Comp = comp.componentProps.children.Component; //获取子组件组件类型\r\n            const { children, ...rest } =\r\n              toJS(child.componentProps, { recurseEverything: true }) || {};\r\n            const requiredRules = findRequiredRules(\r\n              comp.componentProps.children.componentProps,\r\n            );\r\n            if (requiredRules.find(rule => !rest[rule])) {\r\n              return (\r\n                <Alert\r\n                  key={`chil${i}`}\r\n                  message=\"提示\"\r\n                  description=\"属性不全请补齐\"\r\n                  type=\"warning\"\r\n                  showIcon\r\n                />\r\n              );\r\n            }\r\n            return (\r\n              <Comp key={`chil${i}`} {...rest}>\r\n                {children &&\r\n                  renderComponentChildren(\r\n                    comp.componentProps.children as any,\r\n                    children,\r\n                  )}\r\n              </Comp>\r\n            );\r\n          });\r\n        } else if (\r\n          comp.componentProps && //组件含有属性\r\n          comp.componentProps.children && //组件属性中包含子元素\r\n          comp.componentProps.children.type === 'FPR' //子元素为数组\r\n        ) {\r\n          // console.log('renderfpr');\r\n\r\n          return (\r\n            <Observer>\r\n              {() => (\r\n                <FPB components={props.components} FPR defaultDatas={chil} />\r\n              )}\r\n            </Observer>\r\n          ); //组件含有属性 //组件属性中包含子元素\r\n        } else {\r\n          return chil;\r\n        }\r\n      };\r\n      return (\r\n        Component && //存在Component并且\r\n        (!component.componentProps || //没有属性或者\r\n        !component.componentProps.children || //有属性没有子元素或者\r\n        !component.componentProps.children.shouldHaveOne || //或者有子元素不需要默认创建\r\n          (component.componentProps.children && //有子元素并且需要有默认元素并且类型还是数组的需要长度大于0\r\n            component.componentProps.children.shouldHaveOne &&\r\n            component.componentProps.children.type === 'array:component' &&\r\n            children &&\r\n            children.length)) && (\r\n          <ErrorWrapper>\r\n            {props => {\r\n              // console.log('rule',component.componentProps);\r\n              const requiredRules = findRequiredRules(component.componentProps);\r\n              if (requiredRules.find(rule => !finalComponentProps[rule])) {\r\n                return (\r\n                  <Alert\r\n                    message=\"提示\"\r\n                    description=\"属性不全请补齐\"\r\n                    type=\"warning\"\r\n                    showIcon\r\n                  />\r\n                );\r\n              }\r\n              return (\r\n                <Component {...finalComponentProps} {...props}>\r\n                  {children && renderComponentChildren()}\r\n                </Component>\r\n              );\r\n            }}\r\n          </ErrorWrapper>\r\n        )\r\n      );\r\n    };\r\n    let finalComponent = getComponent();\r\n    return (\r\n      <Observer>\r\n        {() => {\r\n          const item = props.store.datas[props.i];\r\n          return (\r\n            <Block\r\n              showTag={!store.isPreview}\r\n              autoHeight={item.autoHeight}\r\n              height={\r\n                props.store.operatedItem &&\r\n                props.store.operatedItem.i === props.i\r\n                  ? props.store.operatedItem.h\r\n                  : props.store.getItemHeight(props.i)\r\n              }\r\n              breakpoint={props.store.breakpoint}\r\n              onParentHeightChange={height => {\r\n                props.store.caclHeight(height, props.i);\r\n              }}\r\n            >\r\n              <Observer>\r\n                {() => {\r\n                  let renderedComponent;\r\n                  if (!store.isPreview) {\r\n                    // console.log('getComponent');\r\n\r\n                    finalComponent = getComponent();\r\n                  }\r\n                  if (item.isFormField && finalComponent) {\r\n                    renderedComponent = (\r\n                      <FormConsumerComponent\r\n                        item={item}\r\n                        component={finalComponent}\r\n                      />\r\n                    );\r\n                    //\r\n                  } else {\r\n                    renderedComponent = finalComponent;\r\n                  }\r\n                  return <>{renderedComponent}</>;\r\n                }}\r\n              </Observer>\r\n            </Block>\r\n          );\r\n        }}\r\n      </Observer>\r\n    );\r\n  },\r\n);\r\nexport default ObservableBlock;\r\n"],"file":"ObservableBlock.js"}