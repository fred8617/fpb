{"version":3,"file":"ObservableBlock.js","names":["getComponent","props","store","item","datas","i","Component","componentProps","componentId","isFormField","isEditing","editingItem","component","flatComponents","toJS","recurseEverything","children","rest","finalComponentProps","defaultValue","value","renderComponentChildren","comp","chil","type","map","child","Comp","requiredRules","findRequiredRules","find","rule","components","shouldHaveOne","length","ObservableBlock","React","memo","finalComponent","isPreview","autoHeight","operatedItem","h","getItemHeight","breakpoint","height","caclHeight","renderedComponent"],"sources":["../src/fpb/ObservableBlock.tsx"],"sourcesContent":["import React, { SFC } from 'react';\nimport { FPBStore, ComponentType } from './useFPBStore';\nimport { Observer } from 'mobx-react-lite';\nimport Block from './Block';\nimport { toJS } from 'mobx';\nimport FormConsumerComponent from './FormConsumerComponent';\nimport FPB from './FPB';\nimport _ from 'lodash';\nimport ErrorWrapper from './ErrorWrapper';\nimport { findRequiredRules } from './utils';\nimport { Alert } from 'antd';\n\nexport interface ObservableBlockProps {\n  i;\n  store: FPBStore;\n  components: ComponentType[];\n}\nconst getComponent = props => {\n  const { store } = props;\n  const item = props.store.datas[props.i];\n  const { Component, componentProps, componentId, isFormField } = item;\n  const isEditing = store.editingItem === item;\n  const component = store.flatComponents[componentId];\n\n  // const component = store.flatComponents[componentId];\n  const { children, ...rest } = toJS(componentProps || {}, {\n    recurseEverything: true,\n  });\n  const finalComponentProps = { ...rest };\n  if (isFormField) {\n    delete finalComponentProps.defaultValue;\n    delete finalComponentProps.value;\n  }\n\n  // component.componentProps&&findRequiredRules(component.componentProps);\n  /**\n   *\n   * @param comp 组件类型\n   * @param chil 表单中的子元素部分\n   */\n  const renderComponentChildren = (comp = component, chil = children) => {\n    // console.log(toJS(children));\n    //debugger;\n    // //debugger\n\n    if (\n      comp.componentProps && //组件含有属性\n      comp.componentProps.children && //组件属性中包含子元素\n      comp.componentProps.children.type === 'array:component' //子元素为数组\n    ) {\n      // if(comp.componentProps.children.shouldHaveOne){\n      //   //debugger\n      //   chil.push({})\n      // }\n      // console.log('child');\n      return chil.map((child, i) => {\n        const Comp = comp.componentProps.children.Component; //获取子组件组件类型\n        const { children, ...rest } =\n          toJS(child.componentProps, { recurseEverything: true }) || {};\n        const requiredRules = findRequiredRules(\n          comp.componentProps.children.componentProps,\n        );\n        if (requiredRules.find(rule => !rest[rule])) {\n          return (\n            <Alert\n              key={`chil${i}`}\n              message=\"提示\"\n              description=\"属性不全请补齐\"\n              type=\"warning\"\n              showIcon\n            />\n          );\n        }\n        return (\n          <Comp key={`chil${i}`} {...rest}>\n            {children &&\n              renderComponentChildren(\n                comp.componentProps.children as any,\n                children,\n              )}\n          </Comp>\n        );\n      });\n    } else if (\n      comp.componentProps && //组件含有属性\n      comp.componentProps.children && //组件属性中包含子元素\n      comp.componentProps.children.type === 'FPR' //子元素为数组\n    ) {\n      // console.log('renderfpr');\n      const Comp = (\n        <Observer>\n          {() => <FPB components={props.components} FPR defaultDatas={chil}/>}\n        </Observer>\n      );\n      return Comp; //组件含有属性 //组件属性中包含子元素\n    } else {\n      return chil;\n    }\n  };\n  return (\n    Component && //存在Component并且\n    (!component.componentProps || //没有属性或者\n    !component.componentProps.children || //有属性没有子元素或者\n    !component.componentProps.children.shouldHaveOne || //或者有子元素不需要默认创建\n      (component.componentProps.children && //有子元素并且需要有默认元素并且类型还是数组的需要长度大于0\n        component.componentProps.children.shouldHaveOne &&\n        component.componentProps.children.type === 'array:component' &&\n        children &&\n        children.length)) && (\n      <ErrorWrapper>\n        {props => {\n          // console.log('rule',component.componentProps);\n          const requiredRules = findRequiredRules(component.componentProps);\n          if (requiredRules.find(rule => !finalComponentProps[rule])) {\n            return (\n              <Alert\n                message=\"提示\"\n                description=\"属性不全请补齐\"\n                type=\"warning\"\n                showIcon\n              />\n            );\n          }\n          return (\n            <Component {...finalComponentProps} {...props}>\n              {children && renderComponentChildren()}\n            </Component>\n          );\n        }}\n      </ErrorWrapper>\n    )\n  );\n};\n/**\n * 观察者区块\n * @param props @interface ObservableBlockProps\n */\nconst ObservableBlock: SFC<ObservableBlockProps> = React.memo(\n  (props: ObservableBlockProps) => {\n    // useEffect(() => {\n    //   console.log(\"mounted\");\n    // }, []);\n    const { store } = props;\n\n    let finalComponent = getComponent(props);\n    return (\n      <Observer>\n        {() => {\n          const item = props.store.datas[props.i];\n          return (\n            <Block\n              showTag={!store.isPreview}\n              autoHeight={item.autoHeight}\n              height={\n                props.store.operatedItem &&\n                props.store.operatedItem.i === props.i\n                  ? props.store.operatedItem.h\n                  : props.store.getItemHeight(props.i)\n              }\n              breakpoint={props.store.breakpoint}\n              onParentHeightChange={height => {\n                props.store.caclHeight(height, props.i);\n              }}\n            >\n              <Observer>\n                {() => {\n                  let renderedComponent;\n                  if (!store.isPreview) {\n                    finalComponent = getComponent(props);\n                  }\n\n                  if (item.isFormField && finalComponent) {\n                    renderedComponent = (\n                      <FormConsumerComponent\n                        item={item}\n                        component={finalComponent}\n                      />\n                    );\n                    //\n                  } else {\n                    renderedComponent = finalComponent;\n                  }\n                  return <>{renderedComponent}</>;\n                }}\n              </Observer>\n            </Block>\n          );\n        }}\n      </Observer>\n    );\n  },\n);\nexport default ObservableBlock;\n"],"mappings":"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"}