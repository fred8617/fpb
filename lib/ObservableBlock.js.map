{"version":3,"sources":["../src/fpb/ObservableBlock.tsx"],"names":["getComponent","props","store","item","datas","i","Component","componentProps","componentId","isFormField","isEditing","editingItem","component","flatComponents","recurseEverything","children","rest","finalComponentProps","defaultValue","value","renderComponentChildren","comp","chil","type","map","child","Comp","requiredRules","find","rule","components","shouldHaveOne","length","ObservableBlock","React","memo","finalComponent","isPreview","autoHeight","operatedItem","h","getItemHeight","breakpoint","height","caclHeight","renderedComponent"],"mappings":"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","sourcesContent":["import React, { SFC } from 'react';\r\nimport { FPBStore, ComponentType } from './useFPBStore';\r\nimport { Observer } from 'mobx-react-lite';\r\nimport Block from './Block';\r\nimport { toJS } from 'mobx';\r\nimport FormConsumerComponent from './FormConsumerComponent';\r\nimport FPB from './FPB';\r\nimport _ from 'lodash';\r\nimport ErrorWrapper from './ErrorWrapper';\r\nimport { findRequiredRules } from './utils';\r\nimport { Alert } from 'antd';\r\n\r\nexport interface ObservableBlockProps {\r\n  i;\r\n  store: FPBStore;\r\n  components: ComponentType[];\r\n}\r\nconst getComponent = props => {\r\n  const { store } = props;\r\n  const item = props.store.datas[props.i];\r\n  const { Component, componentProps, componentId, isFormField } = item;\r\n  const isEditing = store.editingItem === item;\r\n  const component = store.flatComponents[componentId];\r\n\r\n  // const component = store.flatComponents[componentId];\r\n  const { children, ...rest } = toJS(componentProps || {}, {\r\n    recurseEverything: true,\r\n  });\r\n  const finalComponentProps = { ...rest };\r\n  if (isFormField) {\r\n    delete finalComponentProps.defaultValue;\r\n    delete finalComponentProps.value;\r\n  }\r\n\r\n  // component.componentProps&&findRequiredRules(component.componentProps);\r\n  /**\r\n   *\r\n   * @param comp 组件类型\r\n   * @param chil 表单中的子元素部分\r\n   */\r\n  const renderComponentChildren = (comp = component, chil = children) => {\r\n    // console.log(toJS(children));\r\n    //debugger;\r\n    // //debugger\r\n\r\n    if (\r\n      comp.componentProps && //组件含有属性\r\n      comp.componentProps.children && //组件属性中包含子元素\r\n      comp.componentProps.children.type === 'array:component' //子元素为数组\r\n    ) {\r\n      // if(comp.componentProps.children.shouldHaveOne){\r\n      //   //debugger\r\n      //   chil.push({})\r\n      // }\r\n      // console.log('child');\r\n      return chil.map((child, i) => {\r\n        const Comp = comp.componentProps.children.Component; //获取子组件组件类型\r\n        const { children, ...rest } =\r\n          toJS(child.componentProps, { recurseEverything: true }) || {};\r\n        const requiredRules = findRequiredRules(\r\n          comp.componentProps.children.componentProps,\r\n        );\r\n        if (requiredRules.find(rule => !rest[rule])) {\r\n          return (\r\n            <Alert\r\n              key={`chil${i}`}\r\n              message=\"提示\"\r\n              description=\"属性不全请补齐\"\r\n              type=\"warning\"\r\n              showIcon\r\n            />\r\n          );\r\n        }\r\n        return (\r\n          <Comp key={`chil${i}`} {...rest}>\r\n            {children &&\r\n              renderComponentChildren(\r\n                comp.componentProps.children as any,\r\n                children,\r\n              )}\r\n          </Comp>\r\n        );\r\n      });\r\n    } else if (\r\n      comp.componentProps && //组件含有属性\r\n      comp.componentProps.children && //组件属性中包含子元素\r\n      comp.componentProps.children.type === 'FPR' //子元素为数组\r\n    ) {\r\n      // console.log('renderfpr');\r\n      const Comp = (\r\n        <Observer>\r\n          {() => <FPB components={props.components} FPR defaultDatas={chil}/>}\r\n        </Observer>\r\n      );\r\n      return Comp; //组件含有属性 //组件属性中包含子元素\r\n    } else {\r\n      return chil;\r\n    }\r\n  };\r\n  return (\r\n    Component && //存在Component并且\r\n    (!component.componentProps || //没有属性或者\r\n    !component.componentProps.children || //有属性没有子元素或者\r\n    !component.componentProps.children.shouldHaveOne || //或者有子元素不需要默认创建\r\n      (component.componentProps.children && //有子元素并且需要有默认元素并且类型还是数组的需要长度大于0\r\n        component.componentProps.children.shouldHaveOne &&\r\n        component.componentProps.children.type === 'array:component' &&\r\n        children &&\r\n        children.length)) && (\r\n      <ErrorWrapper>\r\n        {props => {\r\n          // console.log('rule',component.componentProps);\r\n          const requiredRules = findRequiredRules(component.componentProps);\r\n          if (requiredRules.find(rule => !finalComponentProps[rule])) {\r\n            return (\r\n              <Alert\r\n                message=\"提示\"\r\n                description=\"属性不全请补齐\"\r\n                type=\"warning\"\r\n                showIcon\r\n              />\r\n            );\r\n          }\r\n          return (\r\n            <Component {...finalComponentProps} {...props}>\r\n              {children && renderComponentChildren()}\r\n            </Component>\r\n          );\r\n        }}\r\n      </ErrorWrapper>\r\n    )\r\n  );\r\n};\r\n/**\r\n * 观察者区块\r\n * @param props @interface ObservableBlockProps\r\n */\r\nconst ObservableBlock: SFC<ObservableBlockProps> = React.memo(\r\n  (props: ObservableBlockProps) => {\r\n    // useEffect(() => {\r\n    //   console.log(\"mounted\");\r\n    // }, []);\r\n    const { store } = props;\r\n\r\n    let finalComponent = getComponent(props);\r\n    return (\r\n      <Observer>\r\n        {() => {\r\n          const item = props.store.datas[props.i];\r\n          return (\r\n            <Block\r\n              showTag={!store.isPreview}\r\n              autoHeight={item.autoHeight}\r\n              height={\r\n                props.store.operatedItem &&\r\n                props.store.operatedItem.i === props.i\r\n                  ? props.store.operatedItem.h\r\n                  : props.store.getItemHeight(props.i)\r\n              }\r\n              breakpoint={props.store.breakpoint}\r\n              onParentHeightChange={height => {\r\n                props.store.caclHeight(height, props.i);\r\n              }}\r\n            >\r\n              <Observer>\r\n                {() => {\r\n                  let renderedComponent;\r\n                  if (!store.isPreview) {\r\n                    finalComponent = getComponent(props);\r\n                  }\r\n\r\n                  if (item.isFormField && finalComponent) {\r\n                    renderedComponent = (\r\n                      <FormConsumerComponent\r\n                        item={item}\r\n                        component={finalComponent}\r\n                      />\r\n                    );\r\n                    //\r\n                  } else {\r\n                    renderedComponent = finalComponent;\r\n                  }\r\n                  return <>{renderedComponent}</>;\r\n                }}\r\n              </Observer>\r\n            </Block>\r\n          );\r\n        }}\r\n      </Observer>\r\n    );\r\n  },\r\n);\r\nexport default ObservableBlock;\r\n"],"file":"ObservableBlock.js"}